{% extends 'base_dashboard.html' %}

{% load static %}

{% block title %}
  Dashboard - MedMinder
{% endblock %}

{% block content %}
  {# Updated Article classes for 2x2 grid on mobile, row on large screens #}
  <article class="grid grid-cols-2 gap-4 lg:flex lg:flex-row lg:gap-4 lg:space-between lg:justify-center lg:items-center"> {# Added items-center for vertical alignment on lg #}

    {# Updated Div classes - removed mobile/small width, keeping padding/margin and lg width/padding #}
    <div class="p-4 sm:p-6 lg:p-8 my-1 lg:my-4 rounded-lg border bg-yellow-50 text-yellow-700 lg:w-1/4 border-yellow-300">
      <h2 class="lg:text-xl font-medium mb-2" id="features">Total Medications</h2>
      {# Adjusted text size/width slightly for mobile grid #}
      <p class="text-xl sm:text-2xl font-bold text-yellow-900">{{ total_medications }}</p>
      <p class="mt-2 sm:mt-4">
        <a class="text-xs text-yellow-600 hover:text-yellow-800" href={% url "medminder:medications"%}>View Medications</a>
      </p>
    </div>

    {# Updated Div classes #}
    <div class="p-4 sm:p-6 lg:p-8 my-1 lg:my-4 rounded-lg border bg-green-50 text-green-700 lg:w-1/4 border-green-300">
      <h2 class="lg:text-xl font-medium mb-2" id="features">Next Reminder</h2>
      {# Adjusted text size/width slightly for mobile grid #}
      {% if next_reminder %}
        <p class="text-xl sm:text-2xl font-bold text-green-900">{{ next_reminder.due_time|time:'H:i' }}</p>
        <p class="mt-2 sm:mt-4">
          <a class="text-xs text-green-600 hover:text-green-800" href="#">{{ next_reminder.reminder.medication }}</a>
        </p>
      {% else %}
        {# Adjusted text size/width slightly for mobile grid #}
        <p class="text-xl sm:text-2xl font-bold text-green-900">No Reminders</p>
      {% endif %}
    </div>

    {# Updated Div classes #}
    <div class="p-4 sm:p-6 lg:p-8 my-1 lg:my-4 rounded-lg border bg-blue-50 text-blue-700 lg:w-1/4 border-blue-300">
      <h2 class="lg:text-xl font-medium mb-2" id="features">Weekly Adherence</h2>
      {# Adjusted text size/width slightly for mobile grid #}
      <p class="text-xl sm:text-2xl font-bold text-blue-900">{{ weekly_adherence }}%</p>
      <p class="mt-2 sm:mt-4">
        <a class="text-xs text-blue-600 hover:text-blue-800" href="#">Last 7 days</a>
      </p>
    </div>

    {# Updated Div classes #}
    <div class="p-4 sm:p-6 lg:p-8 my-1 lg:my-4 rounded-lg border bg-purple-50 text-purple-700 lg:w-1/4 border-purple-300">
      <h2 class="lg:text-xl font-medium mb-2" id="features">Achievement Points</h2>
      {# Adjusted text size/width slightly for mobile grid #}
      <p class="text-xl sm:text-2xl font-bold text-purple-900">{{ achievement_points }}</p>
      <p class="mt-2 sm:mt-4">
        <a class="text-xs text-purple-600 hover:text-purple-800" href="#">{{ user_tier }}</a>
      </p>
    </div>
  </article>

  {# The rest of your template code (Today's Medications table, buttons, style, script) remains the same #}
  <section class="p-8 my-4 lg:my-0 rounded-xl border border-gray-300 bg-white" x-data="{ showAll: false, rowLimit: 3, remindersCount: {{ todays_reminders|length }} }">
    <h2 class="text-2xl font-semibold mb-4">Today's Medications</h2>
    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

    {% if todays_reminders %}
      {# Wrap the table in a div for horizontal scrolling on small screens #}
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-200">
          <thead>
            <tr>
              <th class="px-6 py-3 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">Medication</th>
              <th class="px-6 py-3 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">Dosage</th>
              <th class="px-6 py-3 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">Time</th>
              <th class="px-6 py-3 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody>
            {# Iterate through DailyReminderLog instances, let's name the variable log_entry #}
            {% for log_entry in todays_reminders %}
              {# Use log_entry.id for the row and cell IDs #}
              <tr class="border-b border-gray-200" :style="showAll || {{ forloop.counter0 }} < rowLimit ? '' : 'display: none;'" :id="'reminder-row-' + {{ log_entry.id }}">
                {# Access medication and dosage via the reminder relationship #}
                <td class="px-6 py-4 whitespace-no-wrap text-sm leading-5 text-gray-900 {% if log_entry.status == 'completed' %}line-through{% endif %}" :id="'medication-' + {{ log_entry.id }}">{{ log_entry.reminder.medication }}</td>
                <td class="px-6 py-4 whitespace-no-wrap text-sm leading-5 text-gray-900 {% if log_entry.status == 'completed' %}line-through{% endif %}" :id="'dosage-' + {{ log_entry.id }}">{{ log_entry.reminder.dosage }}</td>
                {# Time is directly on the log entry #}
                <td class="px-6 py-4 whitespace-no-wrap text-sm leading-5 text-gray-900 {% if log_entry.status == 'completed' %}line-through{% endif %}" :id="'due_time-' + {{ log_entry.id }}">{{ log_entry.due_time|time:'H:i' }}</td>
                <td class="px-6 py-4 whitespace-no-wrap text-sm leading-5 text-gray-900" :id="'action-cell-' + {{ log_entry.id }}">
                  {# Check status: show form if not completed #}
                  {% if log_entry.status != 'completed' %}
                    {# Form action should use the log_entry.id #}
                    <form method="post" action="{% url 'medminder:complete_reminder' log_entry.id %}" class="complete-form">
                      {% csrf_token %}
                      <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Complete</button>
                    </form>
                  {% else %}
                    Completed
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div> {# End overflow-x-auto wrapper #}

      {# Use remindersCount from x-data #}
      <button x-show="remindersCount > rowLimit" @click="showAll = !showAll" class="mt-4 text-blue-600 hover:text-blue-800">
        <span x-text="showAll ? 'Collapse' : 'See More'"></span>
        <span :class="showAll ? 'rotate-180' : ''" class="inline-block transition-transform">⬇️</span>
      </button>
    {% else %}
      <p>No reminders for today.</p>
    {% endif %}

    <div class="mt-8">
      <a href="{% url 'medminder:new_plan' %}" class="bg-gray-800 hover:bg-black text-white py-2 px-5 rounded-full">Add new plan</a>
    </div>
  </section>

  {# Updated Style Block for Toasts #}
  <style>
    .toast {
      /* Using Tailwind-like classes */
      --bg-opacity: 0.95; /* Slightly less transparent than original */
      background-color: rgba(220, 252, 231, var(--bg-opacity)); /* green-100 */
      color: rgb(22, 101, 52); /* green-800 */
      padding: 1rem; /* p-4 */
      margin-bottom: 0.625rem; /* ~mb-2.5, adjusting slightly from original 10px */
      border-radius: 0.375rem; /* rounded-md */
      border: 1px solid rgb(74, 222, 128); /* green-400 */
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
      min-width: 250px; /* Ensure a minimum width */
    }

    .toast.show {
      opacity: 1;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const completeForms = document.querySelectorAll('.complete-form');
      const toastContainer = document.getElementById('toast-container');

      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast'; // Uses the updated .toast styles
        toast.textContent = message;
        toastContainer.appendChild(toast);

        // Remove potentially older toasts if too many
        while(toastContainer.children.length > 5) { // Keep max 5 toasts visible
          toastContainer.removeChild(toastContainer.firstChild);
        }


        setTimeout(() => {
          toast.classList.add('show');
          // Use CSS transition duration from the style block for hiding
          setTimeout(() => {
            toast.remove();
          }, 8000); // Hide toast after 8 seconds (adjust as needed)
        }, 100); // Allow slight delay for DOM attachment
      }

      completeForms.forEach((form) => {
        form.addEventListener('submit', function (event) {
          event.preventDefault();
          const formData = new FormData(this);

          fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            },
          })
            .then((response) => {
              if (response.ok) {
                return response.json();
              } else {
                // Handle non-2xx responses
                 return response.json().then(error_data => {
                    console.error('Error response:', error_data);
                    // Show error toast
                    const errorToast = document.createElement('div');
                    // Add distinct error styling (using Tailwind red classes example)
                    errorToast.className = 'toast';
                    errorToast.style.backgroundColor = 'rgba(254, 226, 226, 0.95)'; /* red-100 */
                    errorToast.style.color = 'rgb(153, 27, 27)'; /* red-800 */
                    errorToast.style.border = '1px solid rgb(239, 68, 68)'; /* red-500 */
                    errorToast.textContent = 'Error: ' + (error_data.message || 'Unknown error');
                    toastContainer.appendChild(errorToast);

                     while(toastContainer.children.length > 5) { // Keep max 5 toasts visible
                       toastContainer.removeChild(toastContainer.firstChild);
                     }

                    setTimeout(() => {
                       errorToast.classList.add('show');
                       setTimeout(() => {
                           errorToast.remove();
                       }, 8000); // Hide error toast after 8 seconds
                    }, 100);

                    throw new Error('Server responded with status ' + response.status);
                 });
              }
            })
            .then((data) => {
              // Assuming the server returns JSON with a 'message' and 'points' on success
              if (data.message) {
                showToast(data.message); // Show the success message toast

                // Update the UI dynamically
                // The ID extracted from the URL is the DailyReminderLog ID
                const logEntryId = form.action.split('/').filter(Boolean).pop(); // Use filter(Boolean) to handle trailing slashes

                // Get the specific cells and row using the logEntryId
                const medicationCell = document.getElementById('medication-' + logEntryId);
                const dosageCell = document.getElementById('dosage-' + logEntryId);
                const dueTimeCell = document.getElementById('due_time-' + logEntryId);
                const actionCell = document.getElementById('action-cell-' + logEntryId);
                const reminderRow = document.getElementById('reminder-row-' + logEntryId);

                // Add line-through class to text cells
                if (medicationCell) {
                  medicationCell.classList.add('line-through');
                }
                if (dosageCell) {
                  dosageCell.classList.add('line-through');
                }
                if (dueTimeCell) {
                  dueTimeCell.classList.add('line-through');
                }

                // Update the action cell content
                if (actionCell) {
                  actionCell.innerHTML = 'Completed'; // Or data.status if your backend sends it
                }

                // Optional: Change row styling on completion
                if (reminderRow) {
                  // Use lighter green for completed row background
                  reminderRow.classList.add('bg-green-50');
                  // Optional: Remove or change bottom border color
                  reminderRow.classList.remove('border-b', 'border-gray-200');
                  // Add a completed border color if desired
                  // reminderRow.classList.add('border-l-4', 'border-green-500');
                }

                // Note: If you implement "skip", you might handle that status differently here

                // Optional: Update points/tier display on the dashboard if those elements exist
                // e.g., const pointsElement = document.getElementById('achievement-points');
                // if (pointsElement && data.total_points !== undefined) {
                //    pointsElement.textContent = data.total_points;
                // }
                // const tierElement = document.getElementById('user-tier'); // Assuming you add an ID to the tier p tag
                // if (tierElement && data.user_tier !== undefined) {
                //    tierElement.textContent = data.user_tier;
                // }
              }
            })
            .catch((error) => {
              console.error('Fetch operation failed:', error);
              // The error handling in the .then(response => ...) already showed a toast for server errors.
              // This catch is for network errors or errors thrown from the .then blocks.
              // A network error toast might be shown here if the fetch fails entirely before a response is received.
              // Avoid showing multiple error toasts if the .then handles the error response.
              // This catch block is often less necessary if you handle response.ok in the first .then
               const existingErrorToast = toastContainer.querySelector('.toast[style*="red"]'); // Check for existing red toasts
               if (!existingErrorToast) { // Only show generic network error if no specific server error toast is already shown
                   const networkErrorToast = document.createElement('div');
                    networkErrorToast.className = 'toast';
                    networkErrorToast.style.backgroundColor = 'rgba(254, 226, 226, 0.95)'; /* red-100 */
                    networkErrorToast.style.color = 'rgb(153, 27, 27)'; /* red-800 */
                    networkErrorToast.style.border = '1px solid rgb(239, 68, 68)'; /* red-500 */
                    networkErrorToast.textContent = 'A network error occurred.';
                    toastContainer.appendChild(networkErrorToast);

                     while(toastContainer.children.length > 5) { // Keep max 5 toasts visible
                       toastContainer.removeChild(toastContainer.firstChild);
                     }

                     setTimeout(() => {
                       networkErrorToast.classList.add('show');
                       setTimeout(() => {
                           networkErrorToast.remove();
                       }, 8000); // Hide error toast after 8 seconds
                    }, 100);
               }
            });
        });
      });
    });
  </script>
{% endblock %}